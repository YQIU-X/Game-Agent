# Game Agent 系统运维手册

## 1. 系统概述

### 1.1 系统架构
Game Agent系统采用前后端分离架构：
- **前端**: Vue.js + Element UI
- **后端**: Node.js + Express.js
- **AI训练**: Python + PyTorch
- **数据库**: SQLite
- **WebSocket**: 实时通信

### 1.2 系统组件
- **Web服务器**: Express.js应用
- **AI训练服务**: Python训练脚本
- **模型存储**: 文件系统存储
- **用户管理**: 基于会话的用户认证
- **实时通信**: WebSocket服务

### 1.3 部署环境
- **操作系统**: Windows 10/11, Linux Ubuntu 18.04+
- **Node.js**: 16.14.0+
- **Python**: 3.8.10+
- **内存**: 最低8GB，推荐16GB+
- **存储**: 最低50GB，推荐100GB+

## 2. 系统部署

### 2.1 环境准备

#### 2.1.1 系统要求
```bash
# 检查系统版本
uname -a  # Linux
systeminfo  # Windows

# 检查内存
free -h  # Linux
wmic memorychip get size  # Windows

# 检查磁盘空间
df -h  # Linux
wmic logicaldisk get size,freespace  # Windows
```

#### 2.1.2 安装Node.js
```bash
# 下载并安装Node.js 16.14.0
curl -fsSL https://nodejs.org/dist/v16.14.0/node-v16.14.0-linux-x64.tar.xz | tar -xJ
sudo mv node-v16.14.0-linux-x64 /opt/nodejs
sudo ln -s /opt/nodejs/bin/node /usr/local/bin/node
sudo ln -s /opt/nodejs/bin/npm /usr/local/bin/npm

# 验证安装
node --version
npm --version
```

#### 2.1.3 安装Python
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.8 python3.8-pip python3.8-venv

# CentOS/RHEL
sudo yum install python38 python38-pip

# 验证安装
python3.8 --version
pip3.8 --version
```

#### 2.1.4 安装Python依赖
```bash
# 创建虚拟环境
python3.8 -m venv venv
source venv/bin/activate  # Linux
# venv\Scripts\activate  # Windows

# 安装依赖
pip install torch torchvision torchaudio
pip install gym gym-super-mario-bros
pip install numpy pandas matplotlib
pip install flask requests
```

### 2.2 应用部署

#### 2.2.1 获取代码
```bash
# 克隆代码仓库
git clone <repository-url>
cd game-agent

# 安装Node.js依赖
npm install

# 构建前端
npm run build
```

#### 2.2.2 配置环境变量
```bash
# 创建环境配置文件
cat > .env << EOF
NODE_ENV=production
PORT=3000
DB_PATH=./database.sqlite
LOG_LEVEL=info
MAX_CONCURRENT_TRAINING=5
MAX_CONCURRENT_GAMES=20
EOF
```

#### 2.2.3 启动服务
```bash
# 启动Web服务
npm start

# 或使用PM2管理进程
npm install -g pm2
pm2 start server.js --name "game-agent"
pm2 startup
pm2 save
```

### 2.3 服务配置

#### 2.3.1 Nginx配置（可选）
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 2.3.2 SSL证书配置（可选）
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 3. 系统监控

### 3.1 服务状态监控

#### 3.1.1 进程监控
```bash
# 检查Node.js进程
ps aux | grep node
ps aux | grep python

# 使用PM2监控
pm2 status
pm2 logs game-agent
pm2 monit
```

#### 3.1.2 端口监控
```bash
# 检查端口占用
netstat -tlnp | grep :3000
lsof -i :3000

# 检查服务响应
curl -I http://localhost:3000
```

#### 3.1.3 资源监控
```bash
# CPU使用率
top -p $(pgrep -f "node.*server.js")

# 内存使用
ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -10

# 磁盘使用
df -h
du -sh /path/to/game-agent
```

### 3.2 应用监控

#### 3.2.1 日志监控
```bash
# 查看应用日志
tail -f logs/app.log
tail -f logs/error.log

# 使用PM2查看日志
pm2 logs game-agent --lines 100
```

#### 3.2.2 性能监控
```bash
# 监控API响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:3000/api/health

# 监控数据库性能
sqlite3 database.sqlite "PRAGMA table_info(users);"
```

#### 3.2.3 业务监控
```bash
# 监控训练任务
ps aux | grep "train_.*\.py"

# 监控游戏会话
netstat -an | grep :3000 | wc -l

# 监控模型数量
find experiments/ -name "*.pth" | wc -l
```

### 3.3 告警配置

#### 3.3.1 系统告警
```bash
# 创建监控脚本
cat > monitor.sh << 'EOF'
#!/bin/bash
# CPU使用率告警
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "CPU usage is high: $CPU_USAGE%"
    # 发送告警邮件或短信
fi

# 内存使用率告警
MEM_USAGE=$(free | grep Mem | awk '{printf("%.2f"), $3/$2 * 100.0}')
if (( $(echo "$MEM_USAGE > 80" | bc -l) )); then
    echo "Memory usage is high: $MEM_USAGE%"
    # 发送告警邮件或短信
fi

# 磁盘使用率告警
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | cut -d'%' -f1)
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage is high: $DISK_USAGE%"
    # 发送告警邮件或短信
fi
EOF

chmod +x monitor.sh

# 设置定时任务
crontab -e
# 添加以下行：每5分钟检查一次
*/5 * * * * /path/to/monitor.sh
```

#### 3.3.2 应用告警
```bash
# 服务可用性检查
cat > health_check.sh << 'EOF'
#!/bin/bash
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)
if [ $RESPONSE != "200" ]; then
    echo "Service is down, HTTP status: $RESPONSE"
    # 重启服务
    pm2 restart game-agent
    # 发送告警
fi
EOF

chmod +x health_check.sh
```

## 4. 系统维护

### 4.1 日常维护

#### 4.1.1 日志清理
```bash
# 清理旧日志文件
find logs/ -name "*.log" -mtime +30 -delete

# 压缩大日志文件
gzip logs/app.log.1
gzip logs/error.log.1

# 设置日志轮转
cat > /etc/logrotate.d/game-agent << EOF
/path/to/game-agent/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 node node
    postrotate
        pm2 reload game-agent
    endscript
}
EOF
```

#### 4.1.2 数据库维护
```bash
# 备份数据库
cp database.sqlite database.sqlite.backup.$(date +%Y%m%d)

# 优化数据库
sqlite3 database.sqlite "VACUUM;"
sqlite3 database.sqlite "ANALYZE;"

# 清理过期数据
sqlite3 database.sqlite "DELETE FROM sessions WHERE created_at < datetime('now', '-30 days');"
```

#### 4.1.3 模型文件维护
```bash
# 清理临时文件
find experiments/ -name "*.tmp" -delete
find temp/ -name "*" -mtime +7 -delete

# 压缩旧模型文件
find experiments/ -name "*.pth" -mtime +30 -exec gzip {} \;

# 统计模型文件大小
du -sh experiments/
find experiments/ -name "*.pth" | wc -l
```

### 4.2 定期维护

#### 4.2.1 系统更新
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y  # Ubuntu/Debian
sudo yum update -y  # CentOS/RHEL

# 更新Node.js依赖
npm update

# 更新Python依赖
pip install --upgrade -r requirements.txt
```

#### 4.2.2 安全更新
```bash
# 检查安全漏洞
npm audit
npm audit fix

# 更新Python包
pip install --upgrade pip
pip install --upgrade setuptools wheel
```

#### 4.2.3 性能优化
```bash
# 清理系统缓存
sudo apt clean  # Ubuntu/Debian
sudo yum clean all  # CentOS/RHEL

# 优化文件系统
sudo fstrim -v  # SSD优化

# 重启服务
pm2 restart game-agent
```

### 4.3 故障处理

#### 4.3.1 服务故障
```bash
# 检查服务状态
pm2 status
pm2 logs game-agent --lines 50

# 重启服务
pm2 restart game-agent

# 如果PM2不可用，直接重启
pkill -f "node.*server.js"
npm start
```

#### 4.3.2 数据库故障
```bash
# 检查数据库文件
ls -la database.sqlite
file database.sqlite

# 修复数据库
sqlite3 database.sqlite ".recover" | sqlite3 database_recovered.sqlite

# 恢复备份
cp database.sqlite.backup.20250115 database.sqlite
```

#### 4.3.3 训练故障
```bash
# 检查Python进程
ps aux | grep python
ps aux | grep "train_.*\.py"

# 清理僵尸进程
pkill -f "train_.*\.py"

# 检查GPU状态（如果有）
nvidia-smi
```

#### 4.3.4 网络故障
```bash
# 检查网络连接
ping google.com
netstat -tlnp

# 检查防火墙
sudo ufw status
sudo iptables -L

# 重启网络服务
sudo systemctl restart networking
```

## 5. 备份与恢复

### 5.1 数据备份

#### 5.1.1 数据库备份
```bash
# 创建备份脚本
cat > backup_db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/game-agent"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp database.sqlite $BACKUP_DIR/database_$DATE.sqlite

# 保留最近30天的备份
find $BACKUP_DIR -name "database_*.sqlite" -mtime +30 -delete
EOF

chmod +x backup_db.sh

# 设置定时备份
crontab -e
# 每天凌晨2点备份
0 2 * * * /path/to/backup_db.sh
```

#### 5.1.2 模型文件备份
```bash
# 创建模型备份脚本
cat > backup_models.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/game-agent/models"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
tar -czf $BACKUP_DIR/models_$DATE.tar.gz experiments/

# 保留最近7天的备份
find $BACKUP_DIR -name "models_*.tar.gz" -mtime +7 -delete
EOF

chmod +x backup_models.sh
```

#### 5.1.3 配置文件备份
```bash
# 备份配置文件
cp .env .env.backup
cp server.js server.js.backup
cp package.json package.json.backup
```

### 5.2 数据恢复

#### 5.2.1 数据库恢复
```bash
# 停止服务
pm2 stop game-agent

# 恢复数据库
cp /backup/game-agent/database_20250115_020000.sqlite database.sqlite

# 启动服务
pm2 start game-agent
```

#### 5.2.2 模型文件恢复
```bash
# 停止服务
pm2 stop game-agent

# 恢复模型文件
tar -xzf /backup/game-agent/models/models_20250115_020000.tar.gz

# 启动服务
pm2 start game-agent
```

#### 5.2.3 完整系统恢复
```bash
# 停止所有服务
pm2 stop all

# 恢复代码
git checkout HEAD~1  # 恢复到上一个版本

# 恢复数据库
cp /backup/game-agent/database_20250115_020000.sqlite database.sqlite

# 恢复模型文件
tar -xzf /backup/game-agent/models/models_20250115_020000.tar.gz

# 重新安装依赖
npm install

# 启动服务
pm2 start all
```

## 6. 性能优化

### 6.1 系统优化

#### 6.1.1 内核参数优化
```bash
# 编辑内核参数
sudo vim /etc/sysctl.conf

# 添加以下配置
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_keepalive_probes = 5

# 应用配置
sudo sysctl -p
```

#### 6.1.2 文件系统优化
```bash
# 优化文件描述符限制
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# 优化进程限制
echo "* soft nproc 65535" >> /etc/security/limits.conf
echo "* hard nproc 65535" >> /etc/security/limits.conf
```

### 6.2 应用优化

#### 6.2.1 Node.js优化
```bash
# 设置Node.js环境变量
export NODE_ENV=production
export NODE_OPTIONS="--max-old-space-size=4096"

# 使用PM2集群模式
pm2 start server.js -i max --name "game-agent"
```

#### 6.2.2 Python优化
```bash
# 设置Python环境变量
export PYTHONPATH=/path/to/game-agent/python
export CUDA_VISIBLE_DEVICES=0  # 如果使用GPU

# 优化PyTorch
export OMP_NUM_THREADS=4
export MKL_NUM_THREADS=4
```

### 6.3 数据库优化

#### 6.3.1 SQLite优化
```bash
# 优化SQLite配置
sqlite3 database.sqlite << EOF
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = 10000;
PRAGMA temp_store = MEMORY;
PRAGMA mmap_size = 268435456;
EOF
```

#### 6.3.2 索引优化
```bash
# 创建索引
sqlite3 database.sqlite << EOF
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_sessions_user_id ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_created_at ON sessions(created_at);
EOF
```

## 7. 安全防护

### 7.1 系统安全

#### 7.1.1 防火墙配置
```bash
# 配置UFW防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 3000/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

#### 7.1.2 用户权限
```bash
# 创建专用用户
sudo useradd -m -s /bin/bash gameagent
sudo usermod -aG sudo gameagent

# 设置文件权限
sudo chown -R gameagent:gameagent /path/to/game-agent
chmod 755 /path/to/game-agent
chmod 600 /path/to/game-agent/.env
```

### 7.2 应用安全

#### 7.2.1 HTTPS配置
```bash
# 使用Let's Encrypt
sudo certbot --nginx -d your-domain.com

# 强制HTTPS重定向
# 在Nginx配置中添加
return 301 https://$server_name$request_uri;
```

#### 7.2.2 安全头配置
```bash
# 在Nginx配置中添加安全头
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
```

### 7.3 数据安全

#### 7.3.1 数据加密
```bash
# 加密敏感配置文件
gpg -c .env
rm .env
mv .env.gpg .env.encrypted
```

#### 7.3.2 访问控制
```bash
# 设置数据库文件权限
chmod 600 database.sqlite
chown gameagent:gameagent database.sqlite
```

## 8. 故障排查

### 8.1 常见问题

#### 8.1.1 服务无法启动
```bash
# 检查端口占用
netstat -tlnp | grep :3000

# 检查进程
ps aux | grep node

# 查看日志
pm2 logs game-agent
tail -f logs/error.log
```

#### 8.1.2 训练失败
```bash
# 检查Python环境
python3.8 --version
pip list | grep torch

# 检查GPU状态
nvidia-smi

# 查看训练日志
tail -f logs/training.log
```

#### 8.1.3 数据库连接失败
```bash
# 检查数据库文件
ls -la database.sqlite
file database.sqlite

# 测试数据库连接
sqlite3 database.sqlite "SELECT 1;"
```

### 8.2 日志分析

#### 8.2.1 错误日志分析
```bash
# 查看错误日志
grep "ERROR" logs/app.log
grep "FATAL" logs/app.log

# 统计错误类型
grep "ERROR" logs/app.log | cut -d' ' -f4- | sort | uniq -c
```

#### 8.2.2 性能日志分析
```bash
# 分析响应时间
grep "response_time" logs/app.log | awk '{print $NF}' | sort -n

# 分析慢请求
grep "slow_request" logs/app.log
```

### 8.3 紧急处理

#### 8.3.1 服务完全不可用
```bash
# 1. 检查系统状态
uptime
free -h
df -h

# 2. 重启服务
pm2 restart all

# 3. 如果PM2不可用
pkill -f node
npm start

# 4. 检查网络
ping google.com
netstat -tlnp
```

#### 8.3.2 数据丢失
```bash
# 1. 停止服务
pm2 stop all

# 2. 恢复最新备份
cp /backup/game-agent/database_$(date +%Y%m%d)*.sqlite database.sqlite

# 3. 启动服务
pm2 start all
```

## 9. 运维工具

### 9.1 监控工具

#### 9.1.1 系统监控
```bash
# 安装htop
sudo apt install htop

# 安装iotop
sudo apt install iotop

# 安装nethogs
sudo apt install nethogs
```

#### 9.1.2 应用监控
```bash
# 使用PM2监控
pm2 install pm2-server-monit

# 使用nodemon开发监控
npm install -g nodemon
```

### 9.2 自动化工具

#### 9.2.1 部署脚本
```bash
# 创建部署脚本
cat > deploy.sh << 'EOF'
#!/bin/bash
set -e

echo "开始部署..."

# 备份当前版本
cp -r /path/to/game-agent /path/to/game-agent.backup.$(date +%Y%m%d_%H%M%S)

# 拉取最新代码
cd /path/to/game-agent
git pull origin main

# 安装依赖
npm install

# 构建前端
npm run build

# 重启服务
pm2 restart game-agent

echo "部署完成！"
EOF

chmod +x deploy.sh
```

#### 9.2.2 健康检查脚本
```bash
# 创建健康检查脚本
cat > health_check.sh << 'EOF'
#!/bin/bash

# 检查服务状态
if ! pm2 list | grep -q "game-agent.*online"; then
    echo "服务离线，尝试重启..."
    pm2 restart game-agent
fi

# 检查API响应
if ! curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "API无响应，尝试重启..."
    pm2 restart game-agent
fi

# 检查磁盘空间
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | cut -d'%' -f1)
if [ $DISK_USAGE -gt 90 ]; then
    echo "磁盘空间不足: $DISK_USAGE%"
    # 清理日志文件
    find logs/ -name "*.log" -mtime +7 -delete
fi

echo "健康检查完成"
EOF

chmod +x health_check.sh
```

## 10. 联系信息

### 10.1 技术支持
- **技术支持邮箱**: support@gameagent.com
- **紧急联系电话**: +86-xxx-xxxx-xxxx
- **技术支持QQ群**: 123456789

### 10.2 文档更新
- **文档版本**: v1.0.0
- **最后更新**: 2025年1月15日
- **更新人员**: 运维团队

---

**运维手册编制**: 运维团队  
**手册版本**: v1.0.0  
**编制日期**: 2025年1月15日


